<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ワンピースカード確率計算機 | OPTCG Calc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #F9FAFB; /* gray-50 */
            color: #1F2937; /* gray-800 */
        }
        .font-num {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: #DC2626; /* red-600 */
            border: 4px solid #FFFFFF;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.4);
            cursor: pointer;
            margin-top: -12px;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #E5E7EB; /* gray-200 */
            border-radius: 999px;
        }
        input[type=range]:focus {
            outline: none;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Table Styling */
        .prob-cell {
            transition: all 0.2s;
        }
        .prob-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-20">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-30">
        <div class="max-w-3xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2 overflow-hidden">
                <div class="w-7 h-7 bg-red-600 rounded-lg flex items-center justify-center text-white shadow-sm flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                    </svg>
                </div>
                <!-- Changed: Unified title for mobile/desktop with updated name -->
                <h1 class="font-bold text-base md:text-lg tracking-tight text-gray-900 truncate" data-i18n="appTitle">ワンピースカード確率計算機</h1>
            </div>
            
            <div class="flex items-center gap-3 flex-shrink-0">
                <div class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md font-num">
                    DECK: 50
                </div>
                <!-- Language Switcher -->
                <button id="langToggle" class="flex items-center justify-center w-12 h-7 bg-gray-200 rounded-full relative transition-colors duration-200 focus:outline-none ring-1 ring-gray-300">
                    <span class="sr-only">Toggle Language</span>
                    <span id="langIndicator" class="absolute left-1 w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-200 flex items-center justify-center text-[8px] font-bold text-gray-700">JP</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-3xl mx-auto w-full px-4 pt-6 space-y-8">

        <!-- 1. INPUT SECTION -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-red-50 rounded-bl-full -mr-10 -mt-10 z-0 opacity-50 pointer-events-none"></div>

            <div class="relative z-10">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <label class="block text-xs font-bold text-red-600 uppercase tracking-wider mb-1">
                            Step 1
                        </label>
                        <h2 class="text-xl font-bold text-gray-900" data-i18n="step1Title">デッキへの投入枚数 (N)</h2>
                    </div>
                    
                    <!-- Interactive Number Display -->
                    <div class="relative group cursor-pointer" id="inputContainer">
                        <div class="flex items-baseline gap-1">
                            <span id="targetCountDisplay" class="text-5xl font-num font-bold text-gray-900 tracking-tighter group-hover:text-red-600 transition-colors">4</span>
                            <span class="text-lg font-medium text-gray-400" data-i18n="unitCards">枚</span>
                        </div>
                        <input type="number" id="targetCountDirectInput" min="1" max="30" 
                               class="hidden absolute top-0 right-0 w-32 text-5xl font-num font-bold text-red-600 bg-white text-right outline-none border-b-2 border-red-600 z-10 p-0 m-0">
                        <div class="absolute top-full right-0 mt-1 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] text-gray-400 whitespace-nowrap pointer-events-none" data-i18n="tapToEdit">
                            タップして入力
                        </div>
                    </div>
                </div>

                <!-- Slider -->
                <div class="relative h-10 flex items-center px-1">
                    <input type="range" id="targetCountSlider" min="1" max="30" value="4" step="1" class="z-10">
                    <div class="absolute left-1 right-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div id="sliderProgress" class="h-full bg-red-500 w-[13%]"></div>
                    </div>
                </div>
                <div class="flex justify-between text-xs font-num font-medium text-gray-400 px-1">
                    <span>1</span>
                    <span>10</span>
                    <span>20</span>
                    <span>30</span>
                </div>
            </div>
        </section>

        <!-- 2. REAL-TIME SCENARIOS -->
        <section>
            <div class="grid grid-cols-3 gap-2 md:gap-4">
                
                <!-- Scenario 1 -->
                <div class="bg-blue-50 rounded-xl p-3 md:p-4 border border-blue-100 flex flex-col justify-between relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="text-[10px] md:text-xs font-bold text-blue-600 mb-1 uppercase tracking-wide" data-i18n="scn1Title">マリガンなし</div>
                        <div class="text-[10px] md:text-xs text-blue-800/70 mb-2 leading-tight" data-i18n="scn1Desc">初手5枚 (5ルック)</div>
                        <div class="flex items-baseline gap-0.5">
                            <span id="probScn1" class="text-xl md:text-2xl font-num font-bold text-blue-700">35.3</span>
                            <span class="text-[10px] font-bold text-blue-400">%</span>
                        </div>
                    </div>
                </div>

                <!-- Scenario 2 -->
                <div class="bg-purple-50 rounded-xl p-3 md:p-4 border border-purple-100 flex flex-col justify-between relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="text-[10px] md:text-xs font-bold text-purple-600 mb-1 uppercase tracking-wide" data-i18n="scn2Title">マリガンあり</div>
                        <div class="text-[10px] md:text-xs text-purple-800/70 mb-2 leading-tight" data-i18n="scn2Desc">合計10枚 (10ルック)</div>
                        <div class="flex items-baseline gap-0.5">
                            <span id="probScn2" class="text-xl md:text-2xl font-num font-bold text-purple-700">60.1</span>
                            <span class="text-[10px] font-bold text-purple-400">%</span>
                        </div>
                    </div>
                </div>

                <!-- Scenario 3 -->
                <div class="bg-green-50 rounded-xl p-3 md:p-4 border border-green-100 flex flex-col justify-between relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="text-[10px] md:text-xs font-bold text-green-600 mb-1 uppercase tracking-wide" data-i18n="scn3Title">4ターン目</div>
                        <div class="text-[10px] md:text-xs text-green-800/70 mb-2 leading-tight" data-i18n="scn3Desc">合計15枚 (15ルック)</div>
                        <div class="flex items-baseline gap-0.5">
                            <span id="probScn3" class="text-xl md:text-2xl font-num font-bold text-green-700">76.7</span>
                            <span class="text-[10px] font-bold text-green-400">%</span>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-[10px] text-gray-400 mt-2 text-right" data-i18n="probNote">※1枚以上引ける確率 (単純に山札からN枚引いた場合の確率)</p>
        </section>

        <!-- 3. GRAPH SECTION (NEW) -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
             <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
                    <span class="w-1.5 h-4 bg-gray-800 rounded-full"></span>
                    <span data-i18n="step2GraphTitle">Step 2: 確率推移グラフ</span>
                </h3>
            </div>
            <div class="relative w-full h-64">
                <canvas id="probabilityChart"></canvas>
            </div>
        </section>

        <!-- 4. RESULT TABLE -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-100 bg-gray-50/50 flex items-center justify-between">
                <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
                    <span class="w-1.5 h-4 bg-gray-800 rounded-full"></span>
                    <span data-i18n="step3Title">Step 3: 詳細確率表 (M × L)</span>
                </h3>
                <div class="text-[10px] text-gray-400 font-num" data-i18n="tableAxis">
                    縦: 引く枚数 / 横: 引けた枚数
                </div>
            </div>
            
            <div class="overflow-x-auto flex-grow table-container">
                <table class="w-full text-center border-collapse" id="probTable">
                    <!-- JS generates content -->
                </table>
            </div>

             <!-- Legend -->
             <div class="p-3 bg-gray-50/80 border-t border-gray-100">
                <div class="flex flex-wrap justify-center gap-x-4 gap-y-2 text-[10px] font-medium text-gray-600">
                    <!-- >= 90% -->
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-sm bg-red-500"></div>
                        <span class="font-num">90-100%</span>
                    </div>
                    <!-- 70% - 89.9% -->
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-sm bg-red-400"></div>
                        <span class="font-num">70-89%</span>
                    </div>
                    <!-- 50% - 69.9% -->
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-sm bg-red-200"></div>
                        <span class="font-num">50-69%</span>
                    </div>
                    <!-- 30% - 49.9% -->
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-sm bg-red-100"></div>
                        <span class="font-num">30-49%</span>
                    </div>
                    <!-- 10% - 29.9% -->
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-sm bg-red-50"></div>
                        <span class="font-num">10-29%</span>
                    </div>
                    <!-- 0% - 9.9% -->
                    <div class="flex items-center gap-1.5">
                        <div class="w-3 h-3 rounded-sm bg-gray-100 border border-gray-200"></div>
                        <span class="font-num">0-9%</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. ADVANCED SETTINGS -->
        <section class="border-t border-gray-200 pt-6">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 pl-1" data-i18n="advSettings">
                詳細設定 (Advanced Settings)
            </h3>

            <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                
                <!-- Setting 1: Calculation Mode -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                        <div>
                            <div class="text-sm font-bold text-gray-700" data-i18n="calcMode">計算モード</div>
                            <div class="text-[10px] text-gray-400" data-i18n="calcModeDesc">表の各セルの計算方法を切り替えます</div>
                        </div>
                        <div class="bg-gray-100 p-1 rounded-lg inline-flex">
                            <button id="modeAtLeast" class="px-4 py-2 rounded-md text-xs font-bold transition-all shadow-sm bg-white text-red-600 ring-1 ring-black/5" data-i18n="modeAtLeast">
                                L枚以上 (推奨)
                            </button>
                            <button id="modeExactly" class="px-4 py-2 rounded-md text-xs font-medium transition-all text-gray-500 hover:text-gray-700" data-i18n="modeExactly">
                                ちょうどL枚
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Setting 2: Max Draws -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                        <div>
                            <div class="text-sm font-bold text-gray-700" data-i18n="rangeM">表の表示範囲 (M)</div>
                            <div class="text-[10px] text-gray-400" data-i18n="rangeMDesc">縦軸の最大ドロー数を変更します</div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <label class="cursor-pointer">
                                <input type="radio" name="maxDraws" value="5" class="peer sr-only">
                                <div class="py-1.5 px-3 rounded bg-gray-50 text-gray-500 text-xs font-medium border border-gray-200 peer-checked:bg-gray-800 peer-checked:text-white peer-checked:border-gray-800 transition-all" data-i18n="range5">5枚</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="maxDraws" value="10" class="peer sr-only">
                                <div class="py-1.5 px-3 rounded bg-gray-50 text-gray-500 text-xs font-medium border border-gray-200 peer-checked:bg-gray-800 peer-checked:text-white peer-checked:border-gray-800 transition-all" data-i18n="range10">10枚</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="maxDraws" value="20" checked class="peer sr-only">
                                <div class="py-1.5 px-3 rounded bg-gray-50 text-gray-500 text-xs font-medium border border-gray-200 peer-checked:bg-gray-800 peer-checked:text-white peer-checked:border-gray-800 transition-all" data-i18n="range20">20枚</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="maxDraws" value="50" class="peer sr-only">
                                <div class="py-1.5 px-3 rounded bg-gray-50 text-gray-500 text-xs font-medium border border-gray-200 peer-checked:bg-gray-800 peer-checked:text-white peer-checked:border-gray-800 transition-all" data-i18n="range50">50枚</div>
                            </label>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <script>
        // --- Constants & I18n ---
        const DECK_SIZE = 50;
        const MAX_INPUT = 30;
        
        const i18n = {
            ja: {
                appTitle: "ワンピースカード確率計算機",
                step1Title: "デッキへの投入枚数 (N)",
                unitCards: "枚",
                tapToEdit: "タップして入力",
                scn1Title: "マリガンなし",
                scn1Desc: "初手5枚 (5ルック)",
                scn2Title: "マリガンあり",
                scn2Desc: "合計10枚 (10ルック)",
                scn3Title: "4ターン目",
                scn3Desc: "合計15枚 (15ルック)",
                probNote: "※1枚以上引ける確率 (単純に山札からN枚引いた場合の確率)",
                step2GraphTitle: "Step 2: 確率推移グラフ",
                step3Title: "Step 3: 詳細確率表 (M × L)",
                tableAxis: "縦: 引く枚数 / 横: 引けた枚数",
                advSettings: "詳細設定 (Advanced Settings)",
                calcMode: "計算モード",
                calcModeDesc: "表の各セルの計算方法を切り替えます",
                modeAtLeast: "L枚以上 (推奨)",
                modeExactly: "ちょうどL枚",
                rangeM: "表の表示範囲 (M)",
                rangeMDesc: "縦軸の最大ドロー数を変更します",
                range5: "5枚",
                range10: "10枚",
                range20: "20枚",
                range50: "50枚",
                chartLabelL: "枚引ける",
                chartLabelLAtLeast: "枚以上引ける"
            },
            en: {
                appTitle: "OPTCG Calc",
                step1Title: "Cards in Deck (N)",
                unitCards: "cards",
                tapToEdit: "Tap to edit",
                scn1Title: "No Mulligan",
                scn1Desc: "Opening Hand (5 cards)",
                scn2Title: "With Mulligan",
                scn2Desc: "Total 10 cards",
                scn3Title: "Turn 4",
                scn3Desc: "Total 15 cards",
                probNote: "*Prob. of drawing at least 1 card from a 50-card deck.",
                step2GraphTitle: "Step 2: Probability Graph",
                step3Title: "Step 3: Probability Matrix (M × L)",
                tableAxis: "Rows: Drawn (M) / Cols: Hit (L)",
                advSettings: "Advanced Settings",
                calcMode: "Calculation Mode",
                calcModeDesc: "Switch calculation method for matrix cells",
                modeAtLeast: "At Least L (Rec.)",
                modeExactly: "Exactly L",
                rangeM: "Table Range (M)",
                rangeMDesc: "Max draws displayed in rows",
                range5: "5",
                range10: "10",
                range20: "20",
                range50: "50",
                chartLabelL: " hit(s)",
                chartLabelLAtLeast: " or more hit(s)"
            }
        };

        let currentLang = 'ja';

        // --- DOM Elements ---
        const langToggle = document.getElementById('langToggle');
        const langIndicator = document.getElementById('langIndicator');

        const targetCountSlider = document.getElementById('targetCountSlider');
        const sliderProgress = document.getElementById('sliderProgress');
        const targetCountDisplay = document.getElementById('targetCountDisplay');
        const targetCountDirectInput = document.getElementById('targetCountDirectInput');
        const inputContainer = document.getElementById('inputContainer');
        const probTable = document.getElementById('probTable');
        
        const modeExactlyBtn = document.getElementById('modeExactly');
        const modeAtLeastBtn = document.getElementById('modeAtLeast');
        const maxDrawsRadios = document.getElementsByName('maxDraws');

        const probScn1 = document.getElementById('probScn1');
        const probScn2 = document.getElementById('probScn2');
        const probScn3 = document.getElementById('probScn3');

        // Chart Elements
        const ctx = document.getElementById('probabilityChart').getContext('2d');
        let chartInstance = null;

        // --- State ---
        let calculationMode = 'atLeast'; 

        // --- Logic: Language Switcher ---
        function updateLanguage() {
            const t = i18n[currentLang];
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            // Toggle Visuals
            if (currentLang === 'en') {
                langIndicator.textContent = 'EN';
                langIndicator.style.transform = 'translateX(20px)';
                langToggle.classList.replace('bg-gray-200', 'bg-red-200');
                langIndicator.classList.add('text-red-700');
            } else {
                langIndicator.textContent = 'JP';
                langIndicator.style.transform = 'translateX(0px)';
                langToggle.classList.replace('bg-red-200', 'bg-gray-200');
                langIndicator.classList.remove('text-red-700');
            }

            updateTable(); // Re-render table & chart
        }

        langToggle.addEventListener('click', () => {
            currentLang = currentLang === 'ja' ? 'en' : 'ja';
            updateLanguage();
        });


        // --- High Precision Mathematics (BigInt) ---
        const factorialCache = {};
        function factorial(n) {
            if (n < 0) return 0n;
            if (n === 0 || n === 1) return 1n;
            if (factorialCache[n]) return factorialCache[n];
            let result = 1n;
            for (let i = 2; i <= n; i++) result *= BigInt(i);
            factorialCache[n] = result;
            return result;
        }

        function combinationBigInt(n, r) {
            if (r < 0 || r > n) return 0n;
            if (r === 0 || r === n) return 1n;
            if (r > n / 2) r = n - r;
            let numerator = 1n;
            for (let i = 0; i < r; i++) numerator *= BigInt(n - i);
            let denominator = factorial(r);
            return numerator / denominator;
        }

        function hypergeom(N, K, n, k) {
            if (k < 0 || k > K || k > n) return 0;
            
            const waysToChooseHits = combinationBigInt(K, k);
            const waysToChooseMisses = combinationBigInt(N - K, n - k);
            const totalWays = combinationBigInt(N, n);
            
            if (totalWays === 0n) return 0;

            const PRECISION = 1000000000000n; 
            const numerator = waysToChooseHits * waysToChooseMisses;
            const resultBigInt = (numerator * PRECISION) / totalWays;
            return Number(resultBigInt) / Number(PRECISION);
        }

        function getProbAtLeastOne(N, targetCount, draws) {
            if (draws > (N - targetCount)) return 100.0;
            const probZero = hypergeom(N, targetCount, draws, 0);
            return (1 - probZero) * 100;
        }

        // --- Helper for Calculations ---
        function calculateProb(N, targetCount, draws, hits, mode) {
            const actualTargets = Math.min(targetCount, N);
            if (hits > draws) return 0;
            
            if (mode === 'exactly') {
                return hypergeom(N, actualTargets, draws, hits) * 100;
            } else {
                let sumProb = 0;
                const maxPossibleHits = Math.min(draws, actualTargets);
                for (let k = hits; k <= maxPossibleHits; k++) {
                    sumProb += hypergeom(N, actualTargets, draws, k);
                }
                return sumProb * 100;
            }
        }

        // --- UI Logic ---

        function getCellColor(percentage) {
            if (percentage === 0) return 'bg-white text-gray-200';
            if (percentage < 10) return 'bg-gray-50 text-gray-400';     // 0-9%
            if (percentage < 30) return 'bg-red-50 text-red-800';       // 10-29%
            if (percentage < 50) return 'bg-red-100 text-red-900 font-medium'; // 30-49%
            if (percentage < 70) return 'bg-red-200 text-red-900 font-semibold'; // 50-69%
            if (percentage < 90) return 'bg-red-400 text-white font-bold shadow-sm'; // 70-89%
            return 'bg-red-500 text-white font-bold shadow';            // 90-100%
        }

        function updateScenarios(targetCount) {
            const p5 = getProbAtLeastOne(DECK_SIZE, targetCount, 5);
            const p10 = getProbAtLeastOne(DECK_SIZE, targetCount, 10);
            const p15 = getProbAtLeastOne(DECK_SIZE, targetCount, 15);

            probScn1.textContent = p5.toFixed(1);
            probScn2.textContent = p10.toFixed(1);
            probScn3.textContent = p15.toFixed(1);
        }

        // --- CHART Logic ---
        function initChart() {
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                font: { family: "'Inter', sans-serif", size: 10 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            title: { display: true, text: 'Draws (M)', font: { size: 10 } }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            ticks: { stepSize: 20 },
                            grid: { borderDash: [2, 4], color: '#f3f4f6' }
                        }
                    },
                    elements: {
                        point: { radius: 0, hitRadius: 10, hoverRadius: 4 },
                        line: { tension: 0.4 }
                    }
                }
            });
        }

        function updateChartData(targetCount, maxDraws) {
            if (!chartInstance) return;

            const labels = [];
            for (let m = 1; m <= maxDraws; m++) labels.push(m);

            // We will show lines for L=1, 2, 3, 4
            const linesToShow = 4;
            const datasets = [];
            const colors = [
                { border: '#DC2626', bg: 'rgba(220, 38, 38, 0.1)' }, // Red (L=1)
                { border: '#F59E0B', bg: 'rgba(245, 158, 11, 0.1)' }, // Amber (L=2)
                { border: '#10B981', bg: 'rgba(16, 185, 129, 0.1)' }, // Emerald (L=3)
                { border: '#3B82F6', bg: 'rgba(59, 130, 246, 0.1)' }, // Blue (L=4)
            ];

            const t = i18n[currentLang];
            const suffix = calculationMode === 'atLeast' ? t.chartLabelLAtLeast : t.chartLabelL;

            for (let l = 1; l <= linesToShow; l++) {
                if (l > targetCount) continue; // Don't show line if L > Total Targets

                const dataPoints = [];
                for (let m = 1; m <= maxDraws; m++) {
                    const prob = calculateProb(DECK_SIZE, targetCount, m, l, calculationMode);
                    dataPoints.push(prob);
                }

                datasets.push({
                    label: `${l}${suffix}`,
                    data: dataPoints,
                    borderColor: colors[l-1].border,
                    backgroundColor: colors[l-1].bg,
                    borderWidth: 2,
                    fill: false
                });
            }

            chartInstance.data.labels = labels;
            chartInstance.data.datasets = datasets;
            chartInstance.update();
        }

        // --- Main Update Function ---
        function updateTable() {
            const targetCount = parseInt(targetCountSlider.value);
            let maxDraws = 20;
            for(const radio of maxDrawsRadios) {
                if(radio.checked) maxDraws = parseInt(radio.value);
            }

            // Slider UI
            const progressPercent = ((targetCount - 1) / (MAX_INPUT - 1)) * 100;
            sliderProgress.style.width = `${Math.min(progressPercent, 100)}%`;
            targetCountDisplay.textContent = targetCount;
            targetCountDirectInput.value = targetCount;

            updateScenarios(targetCount);
            updateChartData(targetCount, maxDraws); // Update Graph

            const actualTargets = Math.min(targetCount, DECK_SIZE);
            const displayMaxHits = Math.min(actualTargets, 8); 

            probTable.innerHTML = '';

            // --- Header ---
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const cornerTh = document.createElement('th');
            cornerTh.className = "p-3 bg-gray-50/90 backdrop-blur border-b border-gray-200 text-xs text-gray-400 font-normal sticky top-0 left-0 z-20";
            cornerTh.innerHTML = "M \\ L"; 
            headerRow.appendChild(cornerTh);

            for (let l = 1; l <= displayMaxHits; l++) {
                const th = document.createElement('th');
                th.className = "p-3 bg-gray-50/90 backdrop-blur border-b border-gray-200 text-gray-600 font-bold font-num text-sm min-w-[50px] sticky top-0 z-10";
                th.textContent = `${l}`;
                headerRow.appendChild(th);
            }
            thead.appendChild(headerRow);
            probTable.appendChild(thead);

            // --- Body ---
            const tbody = document.createElement('tbody');
            for (let m = 1; m <= maxDraws; m++) {
                const row = document.createElement('tr');
                const thRow = document.createElement('th');
                thRow.className = "p-2 bg-gray-50/50 border-r border-gray-100 text-gray-500 font-num font-medium text-xs sticky left-0 z-10";
                thRow.textContent = `${m}`;
                row.appendChild(thRow);

                for (let l = 1; l <= displayMaxHits; l++) {
                    const td = document.createElement('td');
                    
                    const probPercent = calculateProb(DECK_SIZE, targetCount, m, l, calculationMode);
                    
                    let percentDisplay;
                    if (probPercent === 0) {
                        percentDisplay = '-';
                    } else if (probPercent < 0.1) {
                        percentDisplay = '<0.1';
                    } else if (probPercent > 99.9 && probPercent < 100) {
                         percentDisplay = '>99.9';
                    } else {
                        percentDisplay = probPercent.toFixed(1);
                    }
                    
                    let borderClass = '';
                    if (calculationMode === 'atLeast') {
                         if ((m === 5 && l === 1) || (m === 10 && l === 1) || (m === 15 && l === 1)) {
                             borderClass = 'ring-2 ring-blue-400 z-20 rounded relative';
                         }
                    }

                    td.className = `p-2 text-sm font-num cursor-default prob-cell ${getCellColor(probPercent)} ${borderClass}`;
                    td.textContent = percentDisplay;
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            }
            probTable.appendChild(tbody);
        }

        // --- Direct Input Logic ---
        function enableDirectInput() {
            targetCountDisplay.classList.add('hidden');
            targetCountDirectInput.classList.remove('hidden');
            targetCountDirectInput.focus();
            targetCountDirectInput.select();
        }

        function commitDirectInput() {
            let val = parseInt(targetCountDirectInput.value);
            if (isNaN(val)) val = 4;
            if (val < 1) val = 1;
            if (val > MAX_INPUT) val = MAX_INPUT;
            targetCountSlider.value = val;
            targetCountDirectInput.classList.add('hidden');
            targetCountDisplay.classList.remove('hidden');
            updateTable();
        }

        inputContainer.addEventListener('click', enableDirectInput);
        targetCountDirectInput.addEventListener('blur', commitDirectInput);
        targetCountDirectInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') targetCountDirectInput.blur(); });

        // --- Event Listeners ---
        function setMode(mode) {
            calculationMode = mode;
            const activeClass = "bg-white text-red-600 shadow-sm ring-1 ring-black/5 font-bold";
            const inactiveClass = "text-gray-500 hover:text-gray-700 font-medium";
            if (mode === 'atLeast') {
                modeAtLeastBtn.className = `px-4 py-2 rounded-md text-xs transition-all ${activeClass}`;
                modeExactlyBtn.className = `px-4 py-2 rounded-md text-xs transition-all ${inactiveClass}`;
            } else {
                modeExactlyBtn.className = `px-4 py-2 rounded-md text-xs transition-all ${activeClass}`;
                modeAtLeastBtn.className = `px-4 py-2 rounded-md text-xs transition-all ${inactiveClass}`;
            }
            updateTable();
        }
        modeExactlyBtn.addEventListener('click', () => setMode('exactly'));
        modeAtLeastBtn.addEventListener('click', () => setMode('atLeast'));

        targetCountSlider.addEventListener('input', updateTable);
        for(const radio of maxDrawsRadios) radio.addEventListener('change', updateTable);

        // Initial Load
        initChart();
        setMode('atLeast');
        updateTable();
        updateLanguage();

    </script>
</body>
</html>